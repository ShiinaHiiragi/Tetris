<!DOCTYPE HTML>

<html>

<head>
  <title>Tetris</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Dependency Include Here -->
  <link href="./semantic/dist/semantic.min.css" rel="stylesheet" type="text/css">
  <script src="./semantic/dist/semantic.min.js"></script>

  <!-- Customized Resources -->
  <style>
    .overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-color: rgba(33, 37, 41, 0.5);
    }

    .panel {
      position: absolute;
      height: 80vh;
      width: 40vw;
      min-width: 80vh;
      top: 10vh;
      left: 30vw;
      background-color: rgba(255, 255, 255, 0.7);
    }

    .side {
      float: left;
      height: 100%;
      width: calc((40vw - 40vh) / 2);
      min-width: 20vh;
    }

    .field {
      float: left;
      height: 100%;
      width: 40vh;
      border: 1px solid rgb(225, 225, 225);
    }

    .cell {
      height: 5%;
      width: 10%;
      float: left;
      background-color: rgb(225, 225, 225);
      border: 1px solid rgb(240, 240, 240);
    }

    .hold {
      width: 100%;
      height: 20vh;
      border: 1.6px solid rgb(225, 225, 225);
      border-right-width: 0.6px;
    }

    .hold-text {
      width: 100%;
      height: 8vh;
      padding-top: 2vh;
      font-size: 3.6vh;
      text-align: center;
      user-select: none;
      color: black;
    }

    .hold-piece {
      position: absolute;
      width: calc((100% - 40vh) / 2);
      height: 8vh;
    }

    .hold-piece-other {
      position: absolute;
      width: 12vh;
      height: 8vh;
      left: calc((100% - 12vh) / 2);
      z-index: 1;
    }

    .hold-piece-o {
      position: absolute;
      width: 8vh;
      height: 8vh;
      left: calc((100% - 8vh) / 2);
      z-index: 2;
    }

    .hold-piece-i {
      position: absolute;
      width: 16vh;
      height: 4vh;
      top: 2vh;
      left: calc((100% - 16vh) / 2);
      z-index: 3;
    }

    .hold-cell {
      height: 4vh;
      width: 4vh;
      float: left;
    }

    .hold-cell-invisible {
      height: 4vh;
      width: 4vh;
      float: left;
    }
    
    .next {
      position: absolute;
      height: 8vh;
      width: calc((100% - 40vh) / 2);
    }

    .next-text {
      position: absolute;
      height: 8vh;
      width: calc((100% - 40vh) / 2);
      padding-top: 2vh;
      font-size: 3.6vh;
      text-align: center;
      user-select: none;
      color: black;
    }

    .combo {
      width: 100%;
      height: 18vh;
      padding-top: 4vh;
      font-size: 2.4vh;
      text-align: center;
      user-select: none;
      color: rgb(231, 76, 60);
      z-index: 2;
    }

    .score {
      width: 100%;
      height: 60vh;
      border: 1.6px solid rgb(225, 225, 225);
      border-top: 0;
      border-right-width: 0.6px;
    }

    .score-bar {
      width: 100%;
      height: 12vh;
      text-align: center;
      user-select: none;
      padding-top: 4vh;
      font-size: 3vh;
    }

    .score-bar>p {
      margin-bottom: 0;
    }

    .info {
      position: absolute;
      width: 40vh;
      height: 8vh;
      left: calc((100% - 40vh) / 2);
      top: 24vh;
      z-index: 4;
      background-color: rgba(255, 255, 255, 0.4);
    }

    #tinfo {
      width: 100%;
      height: 100%;
      line-height: 8vh;
      font-size: 2.8vh;
      text-align: center;
      color: black;
    }

    #start-button {
      position: absolute;
      top: 90vh;
      left: 30vw;
      border-radius: 0;
      width: 40vw;
      min-width: 80vh;
      max-height: 10vh;
    }

    .ranking-panel {
      position: absolute;
      height: 80vh;
      width: 40vw;
      min-width: 80vh;
      z-index: 5;
      background-color: rgba(255, 255, 255, 0.8);
      text-align: center;
      user-select: none;
      padding-top: 8vh;
    }

    #ranking-title {
      margin-bottom: 2vh;
      font-size: 4.8vh;
    }

    #ranking-record {
      margin: auto;
      width: 32vh;
      height: 40vh;
      font-size: 2.4vh;
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="overlay"></div>
  <div class="panel">
    <div class="side" id="left-side">
      <div class="hold">
        <div class="hold-text"><p>Hold</p></div>
        <div class="hold-piece" id="show-0"></div>
      </div>
      <div class="score">
        <div class="combo"><p id="perfect-clear"></p><p id="combo"></p></div>
        <div class="score-bar"><p>Score</p><p id="score">0</p></div>
        <div class="score-bar"><p>Line</p><p id="line">0</p></div>
        <div class="score-bar"><p>Time</p>
          <span id="hour">00</span><span>:</span><span id="minute">00</span><span>:</span><span id="second">00</span>
        </div>
      </div>
    </div>
    <div class="field" id="field">
      <div class="info" id="info"><p id="tinfo"></p></div>
    </div>
    <div class="side" id="right-side">
      <div class="next-text"><p>Next</p></div>
    </div>
    <div class="ranking-panel" id = "ranking-panel">
      <p id="ranking-title">LOCK OUT</p>
      <table id="ranking-record">
        <tbody>
          <tr><td>Max Combo</td><td>11</td></tr>
          <tr><td>Single</td><td>24</td></tr>
          <tr><td>Double</td><td>26</td></tr>
          <tr><td>Triple</td><td>12</td></tr>
          <tr><td>Tetris</td><td>7</td></tr>
          <tr><td>T-Spin Mini</td><td>2</td></tr>
          <tr><td>T-Spin Single</td><td>0</td></tr>
          <tr><td>T-Spin Double</td><td>8</td></tr>
          <tr><td>T-Spin Triple</td><td>6</td></tr>
          <tr><td>B2B Tetris</td><td>0</td></tr>
          <tr><td>B2B T-Spin Mini</td><td>0</td></tr>
          <tr><td>B2B T-Spin Single</td><td>2</td></tr>
          <tr><td>B2B T-Spin Double</td><td>0</td></tr>
          <tr><td>B2B T-Spin Triple</td><td>0</td></tr>
          <tr><td>Perfect Clear</td><td>1</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="ui container">
    <button class="ui button" id="start-button" onclick="initialize()"> Start </button>
  </div>
  <script type="text/javascript" src="src/setting.js"></script>
  <script>
    // process raw setting in the file
    // fallTime: 1 ~ 10; 1: 100ms, 10: 10ms
    // lockTime: 1 ~ 10; 1: 1000ms, 10: 100ms
    // Setting.fallTime = 110 - Setting.fallTime * 10;
    // Setting.lockTime = 1100 - Setting.lockTime * 100;

    // System: important logic data, which cannot be changed by user
    var System =
    {
      pieces:
        [
          null,
          [[[1, 0], [1, -1], [0, -1]], [[0, -1], [-1, -1], [-1, 0]],
            [[-1, 0], [-1, 1], [0, 1]], [[0, 1], [1, 1], [1, 0]]],
          [[[0, 1], [0, -1], [-1, 1]], [[1, 0], [-1, 0], [1, 1]],
            [[0, -1], [0, 1], [1, -1]], [[-1, 0], [1, 0], [-1, -1]]],
          [[[0, 1], [0, -1], [-1, -1]], [[1, 0], [-1, 0], [-1, 1]],
            [[0, -1], [0, 1], [1, 1]], [[-1, 0], [1, 0], [1, -1]]],
          [[[0, 1], [0, -1], [-1, 0]], [[1, 0], [-1, 0], [0, 1]],
            [[0, -1], [0, 1], [1, 0]], [[-1, 0], [1, 0], [0, -1]]],
          [[[0, -1], [-1, 0], [-1, 1]], [[-1, 0], [0, 1], [1, 1]],
            [[0, 1], [1, 0], [1, -1]], [[1, 0], [0, -1], [-1, -1]]],
          [[[0, 1], [-1, -1], [-1, 0]], [[1, 0], [-1, 1], [0, 1]],
            [[0, -1], [1, 1], [1, 0]], [[-1, 0], [1, -1], [0, -1]]],
          [[[0, 1], [0, -1], [0, -2]], [[1, 0], [-1, 0], [-2, 0]],
            [[0, -1], [0, 1], [0, 2]], [[-1, 0], [1, 0], [2, 0]]]
        ],
      // kickWall = [I_clock, I_counter, JLSTZ_clock, JLSTZ_counter]
      kickWall:
      [
        [[[0, 1], [0, -2], [2, 1], [-1, -2]], [[0, -2], [0, 1], [1, -2], [-2, 1]],
          [[0, -1], [0, 2], [-2, -1], [1, 2]], [[0, 2], [0, -1], [-1, 2], [2, -1]]],
        [[[0, 2], [0, -1], [-1, 2], [2, -1]], [[0, 1], [0, -2], [2, 1], [-1, -2]],
          [[0, -2], [0, 1], [1, -2], [-2, 1]], [[0, -1], [0, 2], [-2, -1], [1, 2]]],
        [[[0, -1], [1, -1], [-2, 0], [-2, -1]], [[0, -1], [-1, -1], [2, 0], [2, -1]],
          [[0, 1], [1, 1], [-2, 0], [-2, 1]], [[0, 1], [-1, 1], [2, 0], [2, 1]]],
        [[[0, 1], [1, 1], [-2, 0], [-2, 1]], [[0, -1], [-1, -1], [2, 0], [2, -1]],
          [[0, -1], [1, -1], [-2, 0], [-2, -1]], [[0, 1], [-1, 1], [2, 0], [2, 1]]]
      ],
      // type: 1 ~ 7; O, L, J, T, S, Z, I
      sidePieces:
      [
        null, [6, 7, 8, 9], [2, 3, 4, 5], [0, 3, 4, 5],
        [1, 3, 4, 5], [1, 2, 3, 4], [0, 1, 4, 5], [10, 11, 12, 13]
      ],
      align: [[1, 0], [0, -1], [-1, 0], [0, 1], [1, 0], [0, -1]],
      positionInit: [null, [2, 5], [3, 4], [3, 4], [3, 4], [3, 4], [3, 4], [3, 5]],
      cellEachLine: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      accord: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      ranking: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      sideCount: [6, 4, 4],
      holdPiece: ["hold-piece-other", "hold-piece-o", "hold-piece-i"],
      bgmList: [null, "classic.mp3", "piano.mp3", "t99.mp3",
                "t99_50.mp3", "t99_chip.mp3", "ppt_folk.mp3", "ppt_swap.mp3"],
      seList: ["normal.mp3", "put.mp3", "hold.mp3", "erase.mp3"],
      infoList: [null, "Tetris", "T-Spin Mini", "T-Spin Single", "T-Spin Double", "T-Spin Triple", "Prevented: Locking Down"],
      allowChange: true,
      lastSpin: false,
      lastSpecial: 0,
      perfectClear: false,
      gameStart: false,
      bgm: null,
      se: [null, null, null, null],
      falldownClock: null,
      lockdownClock: null,
      comboClock: null,
      perfectClock: null,
      infoClock: null,
      timerClock: null,
      falldownClockBackup: null,
      lockdownClockBackup: null,
      firstBag: null,
      secondBag: null,
      shuffle: null,
      shufflePointer: 0,
      shuffleInit: function ()
      {
        this.shufflePointer = 0;
        this.firstBag = [1, 2, 3, 4, 5, 6, 7].sort(() => { return 0.5 - Math.random(); });
        this.secondBag = [1, 2, 3, 4, 5, 6, 7].sort(() => { return 0.5 - Math.random(); });
        this.shuffle = this.firstBag.concat(this.secondBag);
      },
      shuffleRefresh: function()
      {
        this.shufflePointer = 0;
        this.firstBag = this.secondBag;
        this.secondBag = null;
        this.secondBag = [1, 2, 3, 4, 5, 6, 7].sort(() => { return 0.5 - Math.random(); });
        this.shuffle = this.firstBag.concat(this.secondBag);
      },
      loadBGM: function()
      {
        if (Setting.bgm > 0)
        {
          this.bgm = document.createElement("audio");
          this.bgm.src = "src/bgm/" + this.bgmList[Setting.bgm];
          this.bgm.volume = 0.5;
          this.bgm.loop = true;
          this.bgm.play();
        }
      },
      loadSE: function()
      {
        for (var index = 0; index < 4; index += 1)
        {
          this.se[index] = document.createElement("audio");
          this.se[index].src = "src/se/" + this.seList[index];
          this.se[index].load();
        }
      },
      asyncTimer: function(delay, execute)
      {
        return new Promise(function (resolve)
        {
          setTimeout(function ()
          {
            execute();
            resolve();
          }, delay);
        });
      },
      gameOver: function(message)
      {
        if (Setting.bgm > 0) this.bgm.pause();
        System.timerClock = window.clearInterval(System.timerClock);
        document.removeEventListener('keydown', Game.keyboardEvent);
        if (this.falldownClock != undefined)
          this.falldownClock = window.clearTimeout(this.falldownClock);
        if (this.lockdownClock != undefined)
          this.lockdownClock = window.clearTimeout(this.lockdownClock);
        Cite.rankingTitle.innerText = message;
        for (var index = 0; index < 15; index += 1)
          Cite.rankingRecord.rows[index].cells[1].innerText = System.ranking[index].toString();
        Cite.rankingPanel.style.display = "block";
      },
      printTimer: function(panel, cite)
      {
        if (panel < 10) cite.innerText = "0" + panel.toString();
        else cite.innerText = panel.toString();
      },
      refreshTimer: function()
      {
        Panel.second += 1;
        if (Panel.second == 60) Panel.second = 0, Panel.minute += 1;
        if (Panel.minute == 60) Panel.minute = 0, Panel.hour += 1;
        System.printTimer(Panel.second, Cite.second);
        System.printTimer(Panel.minute, Cite.minute);
        System.printTimer(Panel.hour, Cite.hour);
      },
      printCombo: function()
      {
        if (System.comboClock != undefined)
          System.comboClock = window.clearTimeout(System.comboClock);
        Cite.combo.innerText = "Combo\n" + Panel.combo.toString();
        System.comboClock = window.setTimeout(function()
        {
          System.comboClock = window.clearTimeout(System.comboClock);
          Cite.combo.innerText = "";
        }, Setting.infoTime);
      },
      printPerfect: function()
      {
        if (System.perfectClock != undefined)
          System.perfectClock = window.clearTimeout(System.perfectClock);
        Cite.perfectClear.innerText = "Perfect Clear";
        System.perfectClock = window.setTimeout(function()
        {
          System.perfectClock = window.clearTimeout(System.perfectClock);
          Cite.perfectClear.innerText = "";
        }, Setting.infoTime);
      },
      printInfo: function(message, b2b)
      {
        if (System.infoClock != undefined)
        System.infoClock = window.clearTimeout(System.infoClock);
        Cite.tinfo.innerText = (b2b ? "B2B " : "") + System.infoList[message];
        Cite.info.style.display = "block";
        System.infoClock = window.setTimeout(function()
        {
          System.infoClock = window.clearTimeout(System.infoClock);
          Cite.tinfo.innerText = "";
          Cite.info.style.display = "none";
        }, Setting.infoTime);
      },
      countDown: async function()
      {
        await System.asyncTimer(Setting.countDown, () => { Cite.tinfo.innerText = "3"; });
        await System.asyncTimer(Setting.countDown, () => { Cite.tinfo.innerText = "2"; });
        await System.asyncTimer(Setting.countDown, () => { Cite.tinfo.innerText = "1"; });
        await System.asyncTimer(Setting.countDown, () =>
        {
          initialize();
          Cite.tinfo.innerText = "Start";
        });
        await System.asyncTimer(Setting.countDown, () =>
        {
          Cite.tinfo.innerText = "";
          Cite.info.style.display = "none";
        });
      },
      countBlock: function()
      {
        var res = 0;
        var xIndex = Pieces.last.position[0], yIndex = Pieces.last.position[1];
        [1, -1].forEach((xOffset) =>
        {
          [1, -1].forEach((yOffset) =>
          {
            if ((xIndex + xOffset >= 0) && (xIndex + xOffset <= 23) &&
                (yIndex + yOffset >= 0) && (yIndex + yOffset <= 9) &&
                Panel.cells[xIndex + xOffset][yIndex + yOffset])
              res += 1;
          });
        });
        return res;
      },
      specialJudge: function(eraseLine)
      {
        // [No, Tetris, TSM, TSS, TSD, TST]
        if (Pieces.last.type == 4 && System.lastSpin && System.countBlock() > 2)
          return Math.min(5, 2 + eraseLine);
        else if (eraseLine > 3) return 1;
        else return 0;
      },
      countScore: function(eraseLine, thisSpecial)
      {
        var score = eraseLine;
        switch (thisSpecial)
        {
          case 1: score += 4; break;
          case 2: score += 0; break;
          case 3: score += 2; break;
          case 4: score += 4; break;
          case 5: score += 6; break;
          default:
            switch (eraseLine)
            {
              case 0: score += 0; break;
              case 1: score += 0; break;
              case 2: score += 1; break;
              case 3: score += 2; break;
            }
            break;
        }
        if (System.lastSpecial && thisSpecial) score += 1;
        if (System.perfectClear) score += 10, System.ranking[14] += 1;
        if (Panel.combo > System.ranking[0]) System.ranking[0] = Panel.combo;
        if (Panel.combo < 2) score += 0;
        else if (Panel.combo < 4) score += 1;
        else if (Panel.combo < 6) score += 2;
        else if (Panel.combo < 8) score += 3;
        else if (Panel.combo < 11) score += 4;
        else score += 5;
        // getting ranking data
        if (thisSpecial)
          System.ranking[thisSpecial + 3 + (System.lastSpecial ? 5 : 0)] += 1;
        else if (eraseLine)
          System.ranking[eraseLine] += 1;
        return score;
      },
      setColor: function(event, element)
      {
        if (System.lockdownClock == undefined)
        {
          if (System.gameStart) Pieces.preview.draw(false, false, false);
          var offset = 0, bias = 1, str = element.id.split("-");
          var xIndex = Number(str[1]) + 4, yIndex = Number(str[2]);
          var rawIndex = Panel.cells[xIndex][yIndex];
          if (event.button == 0) offset = 1;
          else if (event.button == 1) offset = (rawIndex ? 8 - rawIndex : 1);
          else offset = 7;
          var colorIndex = (Panel.cells[xIndex][yIndex] = (rawIndex + offset) % 8);
          if (colorIndex && !rawIndex) System.cellEachLine[xIndex] += 1;
          else if (!colorIndex && rawIndex) System.cellEachLine[xIndex] -= 1;
          element.style.backgroundColor = Setting.color[colorIndex];
          if (System.gameStart)
          {
            while (Pieces.next.shift(Pieces.previewNext, [bias, 0])) bias += 1;
            Pieces.next.shift(Pieces.previewNext, [bias - 1, 0]);
            Pieces.previewNext.draw(true, false, true);
            Pieces.preview.copy(Pieces.previewNext);
            Pieces.now.draw(true, false, false);
          }
        }
        else System.printInfo("Prevented: Locking Down", false);
      }
    }

    // Cite: the element in the HTML DOM
    var Cite =
    {
      rightSide: document.getElementById("right-side"),
      field: document.getElementById("field"),
      hour: document.getElementById("hour"),
      minute: document.getElementById("minute"),
      second: document.getElementById("second"),
      line: document.getElementById("line"),
      score: document.getElementById("score"),
      info: document.getElementById("info"),
      tinfo: document.getElementById("tinfo"),
      combo: document.getElementById("combo"),
      perfectClear: document.getElementById("perfect-clear"),
      startButton: document.getElementById("start-button"),
      rankingPanel: document.getElementById("ranking-panel"),
      rankingTitle: document.getElementById("ranking-title"),
      rankingRecord: document.getElementById("ranking-record"),
      // cells: a two-dimension array citing the 10 × 20 grid
      cells: new Array(20),
      sides: new Array(7)
    }
    document.body.style.backgroundImage = "url('src/img/bg.jpg')";
    // process the raw element in the DOM
    for (var index = 0; index < 20; index += 1)
      Cite.cells[index] = new Array(10).fill(null);
    for (var index = 0; index < 7; index += 1)
      Cite.sides[index] = new Array(14).fill(null);
    for (var index = 0; index < 20; index += 1)
      for (var subIndex = 0; subIndex < 10; subIndex += 1)
      {
        Cite.cells[index][subIndex] = document.createElement("div");
        Cite.cells[index][subIndex].className = "cell";
        Cite.cells[index][subIndex].id = "cell-" + index.toString() + "-" + subIndex.toString();
        if (Setting.debugMode)
          Cite.cells[index][subIndex].setAttribute("onmousedown", "System.setColor(event, this)");
        Cite.field.append(Cite.cells[index][subIndex]);
      }
    Cite.rightSide.style.border = "1.6px solid rgb(225, 225, 225)";
    Cite.rightSide.style.borderLeftWidth = "0.6px";
    for (var index = 1; index <= 6; index += 1)
    {
      var newDiv = document.createElement("div");
      newDiv.className = "next";
      newDiv.id = "show-" + index.toString();
      newDiv.style.top = (12 * (index - 1) + 8).toString() + "vh";
      Cite.rightSide.append(newDiv);
    }
    for (var parentIndex = 0; parentIndex < 7; parentIndex += 1)
    {
      var tempPointer = 0;
      var showIndex = document.getElementById("show-" + parentIndex.toString());
      for (var index = 0; index < 3; index += 1)
      {
        var showTag = document.createElement("div");
        showTag.className = System.holdPiece[index];
        for (var subIndex = 0; subIndex < System.sideCount[index]; subIndex += 1)
        {
          Cite.sides[parentIndex][tempPointer] = document.createElement("div");
          Cite.sides[parentIndex][tempPointer].className = "hold-cell";
          showTag.append(Cite.sides[parentIndex][tempPointer++]);
        }
        showIndex.append(showTag);
      }
    }

    // Panel: The cell and the data of Tetris
    var Panel = {
      cells: new Array(24), hold: 0, 
      score: 0, line: 0, combo: 0,
      hour: 0, minute: 0, second: 0
    }
    // process raw panel data
    for (var index = 0; index < 24; index += 1)
      Panel.cells[index] = new Array(10).fill(0);

    // Piece: The block available for manipupating
    class Piece
    {
      constructor(pos, type, direct)
      {
        // the position of top left corner is [4, 0]
        this.position = pos;
        // type: 1 ~ 7; O, L, J, T, S, Z, I
        this.type = type;
        // direction: 0 ~ 3
        this.direction = direct;
      }

      init(index, saveLast)
      {
        if (saveLast) Pieces.last.copy(this);
        this.type = index;
        this.direction = 0;
        this.position = [System.positionInit[index][0], System.positionInit[index][1]];
        return this.check();
      }

      copy(right)
      {
        this.position = [right.position[0], right.position[1]];
        this.type = right.type;
        this.direction = right.direction;
      }

      // draw the piece on the panel and the array
      // clear: true: print, false: clear
      // heap: true: solid, false: not solid
      draw(clear, heap, transparent)
      {
        var high = true;
        var center = [this.position[0] - 4, this.position[1]];
        var bias = System.pieces[this.type][this.direction];
        if (center[0] >= 0)
        {
          Cite.cells[center[0]][center[1]].style.backgroundColor = Setting.color[clear ? this.type : 0];
          if (transparent) Cite.cells[center[0]][center[1]].style.opacity = "0.5";
          else Cite.cells[center[0]][center[1]].style.opacity = "1";
          high = false;
        }
        Panel.cells[center[0] + 4][center[1]] = (clear && heap ? this.type : 0);
        if (heap) System.cellEachLine[center[0] + 4] += 1;
        for (var index = 0; index < 3; index += 1)
        {
          var bias = System.pieces[this.type][this.direction][index];
          Panel.cells[center[0] + bias[0] + 4][center[1] + bias[1]] = (clear && heap ? this.type : 0);
          if (heap) System.cellEachLine[center[0] + bias[0] + 4] += 1;
          if (center[0] + bias[0] >= 0)
          {
            Cite.cells[center[0] + bias[0]][center[1] + bias[1]].style.backgroundColor =
              Setting.color[clear ? this.type : 0];
            if (transparent) Cite.cells[center[0] + bias[0]][center[1] + bias[1]].style.opacity = "0.5";
            else Cite.cells[center[0] + bias[0]][center[1] + bias[1]].style.opacity = "1";
            high = false;
          }
        }
        return high;
      }

      // check if there is any collision
      // out of the panel or existed pieces
      check()
      {
        var center = [this.position[0] - 4, this.position[1]];
        var bias = System.pieces[this.type][this.direction];
        if (center[0] < -4 || center[0] > 19 || center[1] < 0 || center[1] > 9) return false;
        if (Panel.cells[center[0] + 4][center[1]]) return false;
        for (var index = 0; index < 3; index += 1)
        {
          var bias = System.pieces[this.type][this.direction][index];
          if (center[0] + bias[0] < -4 || center[0] + bias[0] > 19 ||
            center[1] + bias[1] < 0 || center[1] + bias[1] > 9) return false;
          if (Panel.cells[center[0] + bias[0] + 4][center[1] + bias[1]]) return false;
        }
        return true;
      }

      // pos: a bias array (down: [1, 0])
      shift(next, pos)
      {
        next.position = [this.position[0] + pos[0], this.position[1] + pos[1]];
        next.type = this.type;
        next.direction = this.direction;
        return next.check();
      }

      // direct: 1(90) / 2(180) / 3(-90)
      // right: true: clockwise, false: counterclockwise
      rotate(next, direct, right)
      {
        var kickType = null;
        next.position = [this.position[0], this.position[1]];
        next.type = this.type;
        next.direction = (this.direction + direct) % 4;
        if (this.type == 1 || this.type == 7)
          for (var index = 0; index < direct; index += 1)
          {
            next.position[0] += System.align[this.direction + index][0];
            next.position[1] += System.align[this.direction + index][1];
          }
        if (next.check()) return true;
        else if (this.type == 7) kickType = (right ? System.kickWall[0] : System.kickWall[1]);
        else kickType = (right ? System.kickWall[2] : System.kickWall[3]);
        for (var index = 0; index < 4; index += 1)
        {
          next.shift(Pieces.try, kickType[next.direction][index]);
          if (Pieces.try.check())
          {
            next.copy(Pieces.try);
            return true;
          }
        }
        return false;
      }
    }
    var Pieces =
    {
      now: new Piece(), next: new Piece(), try: new Piece(),
      preview: new Piece(), previewNext: new Piece(), last: new Piece()
    }

    var Game =
    {
      // clear: true: print, false: clear
      drawSide: function(pos, type, clear)
      {
        for (index = 0; index < 4; index += 1)
        {
          Cite.sides[pos][System.sidePieces[type][index]].style.backgroundColor = 
          (clear ? Setting.color[type] : "");
          Cite.sides[pos][System.sidePieces[type][index]].style.border =
          (clear ? "1px solid rgb(240, 240, 240)" : "");
        }
        return true;
      },
      chooseTimeInterval: function()
      {
        if (Pieces.now.shift(Pieces.next, [1, 0]))
          System.falldownClock = window.setTimeout(Game.falldownDelay, Setting.fallTime);
        else System.lockdownClock = window.setTimeout(Game.lockdownDelay, Setting.lockTime);
      },
      updatePieceNow: function ()
      {
        Pieces.now.draw(false, false, false);
        Pieces.next.draw(true, false, false);
        Pieces.now.copy(Pieces.next);
      },
      // mode: true: next, clear, false: Pieces.now, not clear
      updatePreviewNow: function(mode)
      {
        var bias = 1;
        if (mode)
        {
          while (Pieces.next.shift(Pieces.previewNext, [bias, 0])) bias += 1;
          Pieces.next.shift(Pieces.previewNext, [bias - 1, 0]);
          Pieces.preview.draw(false, false, false);
          Pieces.now.draw(false, false, false);
          Pieces.previewNext.draw(true, false, true);
          Pieces.next.draw(true, false, false);
          Pieces.preview.copy(Pieces.previewNext);
          Pieces.now.copy(Pieces.next);
        }
        else
        {
          while (Pieces.now.shift(Pieces.preview, [bias, 0])) bias += 1;
          Pieces.now.shift(Pieces.preview, [bias - 1, 0]);
          Pieces.preview.draw(true, false, true);
          Pieces.now.draw(true, false, false);
        }
      },
      updateLine: function()
      {
        for (var index = 23; index >= 0; index -= 1)
          if (index != System.accord[index] && System.accord[index] >= 0)
          {
            for (var subIndex = 0; subIndex < 10; subIndex += 1)
              Panel.cells[index][subIndex] = Panel.cells[System.accord[index]][subIndex];
            System.cellEachLine[index] = System.cellEachLine[System.accord[index]];
            if (index >= 4)
              for (var subIndex = 0; subIndex < 10; subIndex += 1)
                Cite.cells[index - 4][subIndex].style.backgroundColor =
                Setting.color[Panel.cells[System.accord[index]][subIndex]];
          }
          else if (index != System.accord[index])
          {
            for (var subIndex = 0; subIndex < 10; subIndex += 1)
              Panel.cells[index][subIndex] = 0;
            System.cellEachLine[index] = 0;
            if (index >= 4)
              for (var subIndex = 0; subIndex < 10; subIndex += 1)
                Cite.cells[index - 4][subIndex].style.backgroundColor = Setting.color[0];
          }
      },
      keyboardEvent: function(event)
      {
        if (event.keyCode == Setting.keyDownCode.leftQuarter ||
            event.keyCode == Setting.keyDownCode.leftHalf ||
            event.keyCode == Setting.keyDownCode.rightHalf ||
            event.keyCode == Setting.keyDownCode.rightQuarter)
        {
          // used for judging T-Spin
          System.lastSpin = true;
          // reset lockdownClock
          if (System.falldownClock == undefined)
          {
            System.lockdownClock = window.clearTimeout(System.lockdownClock);
            Game.chooseTimeInterval();
          }
          var second;
          if (event.keyCode == Setting.keyDownCode.rightQuarter) second = 1;
          else if (event.keyCode == Setting.keyDownCode.leftQuarter) second = 3;
          else second = 2;
          var third = (event.keyCode == Setting.keyDownCode.rightHalf ||
                      event.keyCode == Setting.keyDownCode.rightQuarter);
          if (Pieces.now.rotate(Pieces.next, second, third))
          {
            Game.updatePreviewNow(true);
            System.se[0].cloneNode().play();
          }
        }
        else if (event.keyCode == Setting.keyDownCode.left ||
                event.keyCode == Setting.keyDownCode.right)
        {
          System.lastSpin = false;
          if (System.falldownClock == undefined)
          {
            System.lockdownClock = window.clearTimeout(System.lockdownClock);
            Game.chooseTimeInterval();
          }
          if (Pieces.now.shift(Pieces.next, [0, (event.keyCode == Setting.keyDownCode.left ? -1 : 1)]))
          {
            Game.updatePreviewNow(true);
            System.se[0].cloneNode().play();
          }
        }
        else if (event.keyCode == Setting.keyDownCode.hold ||
                event.keyCode == Setting.keyDownCode.softDrop ||
                event.keyCode == Setting.keyDownCode.hardDrop)
        {
          System.lastSpin = false;
          if (event.keyCode == Setting.keyDownCode.softDrop && Pieces.now.shift(Pieces.next, [1, 0]))
          {
            Game.updatePieceNow();
            if (System.falldownClock != undefined)
            {
              System.falldownClock = window.clearTimeout(System.falldownClock);
              Game.chooseTimeInterval();
            }
          }
          else if (event.keyCode == Setting.keyDownCode.hardDrop)
          {
            Pieces.next.copy(Pieces.preview);
            Game.updatePieceNow();
            System.falldownClock = window.clearInterval(System.falldownClock);
            Game.lockdownDelay();
          }
          else if (event.keyCode == Setting.keyDownCode.hold && System.allowChange)
          {
            System.allowChange = false;
            Pieces.now.draw(false, false, false);
            if (System.falldownClock != undefined)
                System.falldownClock = window.clearTimeout(System.falldownClock);
            if (System.lockdownClock != undefined)
              System.lockdownClock = window.clearTimeout(System.lockdownClock);
            if (Panel.hold)
            {
              // Piece.now.type  Panel.hold
              var tempNow = Pieces.now.type;
              Game.drawSide(0, Panel.hold, false);
              Game.drawSide(0, Pieces.now.type, true);
              if (Pieces.now.init(Panel.hold, false))
              {
                Pieces.preview.draw(false, false, false);
                Game.updatePreviewNow(false);
                Game.chooseTimeInterval();
              }
              Panel.hold = tempNow;
            }
            else
            {
              Game.drawSide(0, Pieces.now.type, true);
              Panel.hold = Pieces.now.type;
              if (Pieces.now.init(System.shuffle[++System.shufflePointer], false))
              {
                Pieces.preview.draw(false, false, false);
                Game.updatePreviewNow(false);
                Game.chooseTimeInterval();
                for (var index = 1; index <= 6; index += 1)
                {
                  Game.drawSide(index, System.shuffle[System.shufflePointer + index - 1], false);
                  Game.drawSide(index, System.shuffle[System.shufflePointer + index], true);
                }
                if (System.shufflePointer == 7) System.shuffleRefresh();
              }
            }
            System.se[2].cloneNode().play();
          }
        }
        // if ESC is pressed
        else if (event.keyCode == 27)
        {
          System.falldownClockBackup = System.falldownClock;
          System.lockdownClockBackup = System.lockdownClock;
          if (System.falldownClock != undefined)
            System.falldownClock = window.clearTimeout(System.falldownClock);
          if (System.lockdownClock != undefined)
            System.lockdownClock = window.clearTimeout(System.lockdownClock);
        }
      },
      falldownDelay: function()
      {
        System.falldownClock = window.clearTimeout(System.falldownClock);
        if (Pieces.now.shift(Pieces.next, [1, 0]))
        {
          Game.updatePieceNow();
          Game.chooseTimeInterval();
        }
        else System.lockdownClock = window.setTimeout(Game.lockdownDelay, Setting.lockTime);
      },
      lockdownDelay: function()
      {
        System.lockdownClock = window.clearTimeout(System.lockdownClock);
        if (Pieces.now.shift(Pieces.next, [1, 0]))
        {
          Game.updatePieceNow();
          Game.chooseTimeInterval();
        }
        else if (Pieces.now.draw(true, true, false)) System.gameOver("LOCK OUT");
        else if (Pieces.now.init(System.shuffle[++System.shufflePointer], true))
        {
          var sum = 0, ptr = 23, fullLine = new Array(), thisSpecial;
          for (var index = 0; index < 24; index += 1)
          {
            sum += System.cellEachLine[index];
            if (System.cellEachLine[index] == 10) fullLine.push(index);
          }
          System.perfectClear = (sum == fullLine.length * 10);
          if (fullLine.length)
          {
            Panel.combo += 1;
            if (Panel.combo > 1) System.printCombo();
            System.se[3].cloneNode().play();
            Panel.line += fullLine.length;
            Cite.line.innerText = Panel.line.toString();
          }
          else
          {
            Panel.combo = 0;
            System.se[1].cloneNode().play();
          }
          if (System.perfectClear) System.printPerfect();
          thisSpecial = System.specialJudge(fullLine.length);
          if (thisSpecial) System.printInfo(thisSpecial, System.lastSpecial);
          Panel.score += System.countScore(fullLine.length, thisSpecial);
          Cite.score.innerText = Panel.score.toString();
          if (fullLine.length) System.lastSpecial = thisSpecial;
          // erase the full lines
          for (var index = 23; index >= 0; index -= 1, ptr -= 1)
          {
            while (fullLine.includes(ptr)) ptr -= 1;
            System.accord[index] = ptr;
          }
          Game.updateLine();
          Game.updatePreviewNow(false);
          System.allowChange = true;
          Game.chooseTimeInterval();
          for (var index = 1; index <= 6; index += 1)
          {
            Game.drawSide(index, System.shuffle[System.shufflePointer + index - 1], false);
            Game.drawSide(index, System.shuffle[System.shufflePointer + index], true);
          }
          if (System.shufflePointer == 7) System.shuffleRefresh();
        }
        else System.gameOver("LOCK OUT");
      }
    };
    System.loadSE();
    System.shuffleInit();
    Cite.rankingPanel.style.display = "none";
    Pieces.now.init(System.shuffle[System.shufflePointer], false);
    document.oncontextmenu = function(event) { event.preventDefault(); };

    if (Setting.debugMode) Cite.info.style.display = "none";
    else
    {
      Cite.startButton.style.display = "none";
      Cite.tinfo.innerText = "Ready";
      window.setTimeout(System.countDown, Setting.countDown);
    }

    function initialize()
    {
      if (Setting.debugMode) Cite.startButton.style.display = "none";
      System.gameStart = true;
      System.loadBGM();
      Game.updatePreviewNow(false);
      for (var index = 1; index <= 6; index += 1)
        Game.drawSide(index, System.shuffle[System.shufflePointer + index], true);
      Game.chooseTimeInterval();
      System.timerClock = window.setInterval(System.refreshTimer, 1000);
      document.addEventListener('keydown', Game.keyboardEvent);
    }
  </script>
</body>

</html>